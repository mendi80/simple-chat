
<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--link rel="stylesheet" href="style.css"-->
	<style> 
		#jojojj { width:80vw; padding:0; margin:0 auto; box-sizing: border-box; }
		body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: rgb(153, 98, 139)}
		//body { background: linear-gradient( 45deg, #1e7752, #e73c7e, #23a6d5, #23d5ab); background-attachment: fixed; background-size: 400% 400%; animation: AnimationName 10s ease infinite;}
		//@keyframes AnimationName { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

		h1 { margin-top:2vh; padding:0; text-align:center; text-transform: uppercase; font-weight: 300; font-size:4vw; letter-spacing: 0.2vw; color:#a1215170; }
		h1::after { content:""; display:flex; border-top: 2px solid #585858; margin-top: .2em;}
		header {background-color: #22222277;overflow: hidden;text-align: center;font-size: 37px;}
		header a {color: #f2f2f2;text-decoration: none;}
	 	footer {background-color: #22222277; color: white; padding: 15px; position: fixed; left: 0; bottom: 0; width: 100%;}


		#user_namepwd {width: 100px;}
		#inputAddRow { height:48px; background:#bfb5; border:none; padding: 8px 18px; font-family:"Raleway", sans-serif; font-size:32px; }
		#inputAddRow:focus {outline:none;}
		.btn1 {background-color:#aaaaaaaa; height:40px; font-size:24px; display:inline-block; border:0.1em solid #FFFFFF; margin:2px auto 10px auto;
							border-radius:5px; font-family:'Roboto',sans-serif; font-weight:300; color:#000; text-align:center; transition: all 0.5s;}		
		.btn1:hover {color:#f00;background-color:#527;}
		#searchBox { height:48px; background:#fff; border:none; padding: 8px 18px; font-family:"Raleway", sans-serif; font-size:32px; }
		#searchBox:focus {outline:none;}
		#searchResult {padding:32px; list-style:none; background:#555; color:#fff; height:400px; overflow-y:scroll;}
		#searchResult li {padding:8px 0px; border-left: 1px solid #645f5f; padding-left: 24px;}
		#searchResult::-webkit-scrollbar { width:8px; background:#111;}
		#searchResult::-webkit-scrollbar-thumb { width:8px; background:#880;}

		table {font-family: arial, sans-serif; border-collapse: collapse; width: 100%;}
		th {border: 1px solid #dddddd; text-align: center; padding: 8px;}
		td {border: 1px solid #dddddd; text-align: right; padding: 8px;}
		tr:nth-child(even) {background-color: #dddddd;}
		tbody.forumTitles tr:hover {background-color: #fbc93d; cursor:default;}

		#writingPostTitle, #writingPostContent {display:block;width:80%;padding:.375rem 2.75rem;margin:16px; margin-right:30px; font-size:1rem;
		font-weight:400;line-height:1.5;color:#495057;background-color:#fff;background-clip:padding-box;border:3px solid #ced4da;border-radius:.25rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
		textarea, input { background: #6f6f6f !important;color: #f2f2f2 !important; border: none !important;}
		::placeholder { color: #f2f2f2 !important; opacity: 1; /* Firefox */} /* Chrome, Firefox, Opera, Safari 10.1+ */
		article {white-space: pre-wrap;	min-height: 5em; min-width: 20em;min-width: 80em; background-color:#386;}
	</style>

	<style>
		.switch { position: relative; display: inline-block; height: 34px; width: 60px; }
		.switch input { opacity: 0; width: 0; height: 0;}
		.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; -webkit-transition: .4s; transition: .4s;}
		.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; -webkit-transition: .4s; transition: .4s;}
		input:checked + .slider { background-color: #2196F3;}
		input:focus + .slider { box-shadow: 0 0 1px #2196F3;}
		input:checked + .slider:before { -webkit-transform: translateX(26px); -ms-transform: translateX(26px); transform: translateX(26px);}
	</style>

	<title>Mendi Forum</title>
</head>


<!-- *************************************************************BODY****************************************************************** -->
<body dir="rtl" data-rpost_id="0">
<header><a href="/">Mendi Forum ©</a></header>
<h1 id='datetime' />
<h3 id="myInfo" style="display:block">-</h3>
<h3 id="myInfo2" style="display:block">-</h3>

<div id="user_namepwd">
	<input type="text" id="inputUserNickname" placeholder="כינוי">
	<input type="password" id="inputUserPassword" placeholder="ססמה">
</div>

<div id="div_fetchtitles" style="display:none">
	<label class="switch"><input type="checkbox" id="chkFetchTitles" name="FetchTitles" checked><span class="slider"></span></label>
	<button type="button" class="btn1" onclick="btnStartNewPost()">כתוב הודעה חדשה</button>
	<button type="button" class="btn1" onclick="btnCreateRandomTable(10)">צור טבלה</button>
	<table><thead><th>מספר</th><th>ID</th><th>כותרת</th><th>שם הכותב</th><th>תאריך כתיבה</th><th>צפיות</th></thead>
	<tbody class="forumTitles" id="forumtitles"></tbody>
	</table>
</div>

<div id="template_replytitle" style="display:none">
	<li data-post_id="0000000">
		<p class="PostID"></p>
		<h4 class="ReplyTitle"></h4>
		<ul></ul>
	</li>
</div>
<div id="div_replytitles" style="display:none">

</div>
<div id="div_replywithcontent" style="display:none">

</div>
<div id="template_replywithcontent" style="display:none">
	<li data-post_id="0000000">
		<p class="PostID"></p>
		<h4 class="ReplyTitle" ></h4>
		<article class="ReplyContent"></article>
		<button type="button" class="btn1" onclick="btnBackToTitles(this,event)">בטל וחזור</button>
		<button type="button" class="btn1" onclick="btnStartEditPost(this,event)">ערוך הודעה</button>
		<button type="button" class="btn1" onclick="btnStartReply(this,event)">תגובה</button>
		<div></div>
		<ul></ul>
	</li>
</div>


<div id="div_writingpost" style="display:none" data-post_id="0000000" data-ppost_id="0000000">
	<input type="text" id="writingPostTitle" placeholder="Title" oninput="oninputTitle()">
	<textarea id="writingPostContent" name="postcontent" dirname="postcontent.dir" placeholder="תוכן" oninput="oninputContent()" rows="20" cols="50" maxlength="1000" > </textarea>
	<button type="button" class="btn1" onclick="btnCancelReply()">בטל תגובה</button>
	<button type="button" class="btn1" id="btnSendPost" onclick="btnSendPost()"> שדר</button>
	<h2 id="previewPostTitle" class="PostTitle"></h1>
	<article id="previewPostContent" class="PostContent"></article>
</div>
<div id="tmp1"></div>
<!--footer><address><p>Author: Mendi<br><a href="mendi@mendi.com">mendi@gmail.com</a></p></address> </footer-->

<!-- ************************************************************SCRIPTS******************************************************************* -->

<script id="script_state">
	"use strict";
	
	var myInfo=document.getElementById("myInfo");
	var myInfo2=document.getElementById("myInfo2");
	function setInfo(x) {myInfo.innerHTML=x;}
	function setInfo2(x) {myInfo2.innerHTML=x;}

	var isMobile = 'ontouchstart' in window;
	
	var tmp_last_rpost_id = 0;
	function setRootPostID(newrpost_id)
	{
		console.assert(document.body.dataset.rpost_id==tmp_last_rpost_id,'rpost_id changed from outside and its not allowed')
		console.assert(newrpost_id>=0, 'rpost_id must be non negative');
		document.body.dataset.rpost_id = newrpost_id;
		tmp_last_rpost_id = newrpost_id;
	}
	
	const pagestates = {INIT:"Init",FETCHTITLES:"FectTitles", READING:"ReadingPost", STARTING_NEWPOST:"WritingPost", EDITING_OLDPOST:"EditingPost"}
	const forum_div_ids = new Array( "div_fetchtitles", "div_writingpost", "div_replytitles","div_replywithcontent");
	var pagestate = pagestates.INIT, prev_pagestate = pagestates.INIT;
	function setPageState(newstate)
	{
		if (Object.values(pagestates).indexOf(newstate) <= 0) // init also illegael, otherwise <= -1 will include init
 			console.error(`error in setPageState. newstate=${newstate} not exist`);
		
		console.assert(newstate!=pagestate)
		prev_pagestate = pagestate;
		pagestate = newstate;
		
		for (let i = 0, len = forum_div_ids.length; i < len; i++) document.getElementById(forum_div_ids[i]).style.display = "none";

		switch(pagestate)
		{
			case pagestate.INIT: 
				console.error('setPageState init error');
				break;
			case pagestates.FETCHTITLES:			
				document.getElementById("div_fetchtitles").style.display = "block";
				break;
			case pagestates.READING:	
				//document.getElementById("div_replytitles").style.display = "list-item";
				document.getElementById("div_replywithcontent").style.display = "list-item";
				break;
			case pagestates.STARTING_NEWPOST:
				//document.getElementById("div_replytitles").style.display = "list-item";
				document.getElementById("div_replywithcontent").style.display = "list-item";
				document.getElementById("div_writingpost").style.display = "block";
				break;
			case pagestates.EDITING_OLDPOST:
				document.getElementById("div_writingpost").style.display = "block";
				break;
		}
	}

	function btnStartNewPost(){
		document.getElementById("div_writingpost").dataset.post_id = "-1";
		document.getElementById("div_writingpost").dataset.ppost_id = "0";
		setPageState(pagestates.STARTING_NEWPOST) 
	}

	function btnStartReply(me,ev){
		document.getElementById("div_writingpost").dataset.post_id = "-1";
		document.getElementById("div_writingpost").dataset.ppost_id = me.parentElement.dataset.post_id;
		me.parentElement.getElementsByTagName("div")[0].appendChild(document.getElementById("div_writingpost"));
		setPageState(pagestates.STARTING_NEWPOST) 
	}
	function btnStartEditPost(me,ev)
	{
		document.getElementById("div_writingpost").dataset.post_id = me.parentElement.dataset.post_id;
		document.getElementById("div_writingpost").dataset.ppost_id = me.parentElement.dataset.post_id;
		document.getElementById("div_writingpost").querySelector("#writingPostTitle").value = me.parentElement.children[1].innerHTML;
		document.getElementById("div_writingpost").querySelector("#writingPostContent").value = me.parentElement.children[2].innerHTML;
		oninputTitle(); //prepare preview
		oninputContent(); //prepare preview
		setPageState(pagestates.EDITING_OLDPOST);
	}
	
	function btnBackToTitles(me,ev){
		document.getElementById("div_writingpost").dataset.post_id = "0";
		document.getElementById("div_writingpost").dataset.ppost_id = "0";
		document.body.appendChild(document.getElementById("div_writingpost"));
		setPageState(pagestates.FETCHTITLES);
	}
	function btnCancelReply(me,ev){
		document.getElementById("div_writingpost").dataset.post_id = "0";
		document.getElementById("div_writingpost").dataset.ppost_id = "0";
		document.body.appendChild(document.getElementById("div_writingpost"));
		setPageState(pagestates.READING);
	}
	function btnSendPost()
	{
		sendPost(document.getElementById("div_writingpost").dataset.post_id, document.getElementById("div_writingpost").dataset.ppost_id);
	}
	function afterPostSent()
	{
		document.getElementById("div_writingpost").dataset.post_id = "0";
		document.getElementById("div_writingpost").dataset.ppost_id = "0";
		document.body.appendChild(document.getElementById("div_writingpost"));
		setPageState(prev_pagestate);
	}
</script>

<script id="script_clearcontent"> 
	function clearPostContent()
	{
		document.getElementById("writingPostTitle").value="";
		document.getElementById("writingPostContent").value="";
	}
</script>

<script id="script_readingpost">
	"use strict";

	function displayPost(data)
	{
		//console.log(data);
		
		//fields: post_id, ppost_id, rpost_id, created, nickname, title, content
		console.assert(data[0]["post_id"]==data[0]["rpost_id"]  && data[0]["ppost_id"]==0, "error in post data reply");

		//map from post_id to array index
		let postid2idx = new Map();	for (let i=0, N=data.length; i<N; i++) postid2idx.set(data[i]["post_id"],i);

		// prepare reply
		
		let template_replytitle = document.getElementById("template_replytitle").children[0];
		let template_replywithcontent = document.getElementById("template_replywithcontent").children[0];
		let all_replytitles = [], all_replywithcontent = []
		for (let i=0, N=data.length; i<N; i++) {
			if(i>0)
				console.assert(data[i]["post_id"]>0&&data[i]["ppost_id"]>0,'data[i]["post_id"]>0&&data[i]["ppost_id"]>0')
			else
				console.assert(data[i]["post_id"]>0&&data[i]["ppost_id"]==0,'data[i]["post_id"]>0&&data[i]["ppost_id"]==0')
			
			let cln1 = template_replytitle.cloneNode(true);
			cln1.dataset.post_id=data[i]["post_id"];
			cln1.children[0].innerHTML=`idx=${i}/${N} post_id=${data[i]["post_id"]}, ppost_id=${data[i]["ppost_id"]}, rpost_id=${data[i]["rpost_id"]}`;
			cln1.children[1].innerHTML=data[i]["title"];
			all_replytitles.push(cln1);
			
			let cln2 = template_replywithcontent.cloneNode(true);
			cln2.dataset.post_id=data[i]["post_id"];
			cln2.children[0].innerHTML=`idx=${i}/${N} post_id=${data[i]["post_id"]}, ppost_id=${data[i]["ppost_id"]}, rpost_id=${data[i]["rpost_id"]}`;
			cln2.children[1].innerHTML=data[i]["title"];
			cln2.children[2].innerHTML=data[i]["content"];
			
			all_replywithcontent.push(cln2);
		}

		// structure reply
		const idx_ul1=Array.from(template_replytitle.children).indexOf(template_replytitle.getElementsByTagName("ul")[0]); console.assert(idx_ul1>=0, "idx_ul1<0")
		for (let i=1, N=data.length; i<N; i++) 	all_replytitles[postid2idx.get(data[i]["ppost_id"])].children[idx_ul1].appendChild(all_replytitles[i]);
		document.getElementById("div_replytitles").innerHTML="<ul>"+all_replytitles[0].outerHTML.replaceAll("<ul></ul>\n","").replaceAll("\t","")+"</ul>";

		const idx_ul2=Array.from(template_replywithcontent.children).indexOf(template_replywithcontent.getElementsByTagName("ul")[0]); console.assert(idx_ul2>=0, "idx_ul2<0")
		for (let i=1, N=data.length; i<N; i++) 	all_replywithcontent[postid2idx.get(data[i]["ppost_id"])].children[idx_ul2].appendChild(all_replywithcontent[i]);
		document.getElementById("div_replywithcontent").innerHTML="<ul>"+all_replywithcontent[0].outerHTML.replaceAll("<ul></ul>\n","").replaceAll("\t","")+"</ul>";

		setPageState(pagestates.READING);
	}
	
	var tTitleTouchStarted = performance.now();
	var tTitleTouchEnded = performance.now();
	var tScrolled = performance.now();
	
	function titleRowClicked(post_id)
	{
		tTitleTouchEnded = performance.now();
		if(!isMobile || tTitleTouchEnded-tTitleTouchStarted<300 && tTitleTouchEnded-tScrolled>200)
			setRootPostID(post_id)
	}


</script>


<script id="script_writingpost">
	"use strict";

	var elem_writingPostTitle=document.getElementById("writingPostTitle");
	var elem_writingPostContent=document.getElementById("writingPostContent");
	var elem_previewPostTitle=document.getElementById("previewPostTitle");
	var elem_previewPostContent=document.getElementById("previewPostContent");

	function oninputTitle()
	{
		elem_previewPostTitle.innerHTML = elem_writingPostTitle.value;
		elem_previewPostTitle.dir = elem_writingPostTitle.dir;
	}
	function oninputContent()
	{
		elem_previewPostContent.innerHTML = elem_writingPostContent.value;
		elem_previewPostContent.dir = elem_writingPostContent.dir;
	}

	function btnCreateRandomTable(N)
	{
		let newRows = new FormData();
		newRows.set('op', "create_random_table");
		newRows.set('nrows', N);
		fetch('./op.php', {method: 'POST', body: newRows})
		.then(res => res.text())
		.then(res => console.log(`CreateRandomTable N=${N} time=${res}`))
		.catch(e => console.error('Error, sendPost(), ' + e))
	}
	const newPost = new FormData();
	newPost.set('op', "setpost");

	function sendPost(post_id, ppost_id) {
		newPost.set('post_id', post_id);
		newPost.set('ppost_id', ppost_id);
		newPost.set('nickname',document.getElementById("inputUserNickname").value);
		newPost.set('secret',document.getElementById("inputUserPassword").value);
		newPost.set('title',document.getElementById("writingPostTitle").value);
		newPost.set('content',document.getElementById("writingPostContent").value);

		fetch('./op.php', {method: 'POST', body: newPost})
		.then(res => res.text())
		.then(res => {console.log(res);if (res=="1") {afterPostSent();  }})
		.catch(e => console.error('Error, sendPost(), ' + e))
	}
</script>

<script id="script_timer_fetchtitles">
	"use strict";
	
	var chkFetchTitles = document.getElementById("chkFetchTitles");
	var forumtitles = document.getElementById("forumtitles");
	let touchEvent = isMobile ? 'ontouchstart=touchTitleStarted() ontouchend' : 'onclick';
	var t0Fetch = performance.now();
	var t1Fetch = performance.now();

	function updateForum(data) {
		if (!Array.isArray(data)) return; // no new data
		console.assert(data.length==2, "length should b 2")
		let rpost_id = Number(data[0]['rpost_id']);
		let n_replies = Number(data[0]['n_replies']);
		let n_edits = Number(data[0]['n_edits']);
		let data1 = data[1];
		let is_n_replies_changes = !all_n_replies.has(rpost_id) || all_n_replies.get(rpost_id)!=n_replies;
		let is_n_edits_changes = !all_n_edits.has(rpost_id) || all_n_edits.get(rpost_id)!=n_edits;
		console.assert(is_n_replies_changes || is_n_edits_changes, "at least one should be different")
		all_n_replies.set(rpost_id,n_replies);
		all_n_edits.set(rpost_id,n_edits);
		if (rpost_id==0) //main titles
		{
			let new_rows=""; 
			for (let i=data1.length-1, k=1; i>=0; i--,k++) 
			{
				let d=data1[i];
				new_rows += `\t<tr ${touchEvent}=titleRowClicked(${d["post_id"]})><td>${k}</td><td>${d["post_id"]}</td><td>${d["title"]}</td><td>${d["nickname"]}</td><td>${d["created"]}</td><td>${770}</td>\n`;
			}
			forumtitles.innerHTML = new_rows;
		}
		else // inside post
		{
			displayPost(data1);
		}
		
		t1Fetch = performance.now();
		console.log(`pingAndFetch done. runtime=${(t1Fetch-t0Fetch).toFixed(1)} ms`);
	}
	
	const all_n_replies = new Map();
	const all_n_edits = new Map();
	const pingFormData = new FormData(); 
	pingFormData.set('op', "fetch");
	function pingAndFetch() {
		console.log('pingAndFetch started');
		t0Fetch = performance.now();
		let rpost_id = Number(document.body.getAttribute('data-rpost_id')); //faster than dataset
		pingFormData.set('rpost_id', rpost_id);
		pingFormData.set('n_replies', all_n_replies.has(rpost_id)?all_n_replies.get(rpost_id):-1);
		pingFormData.set('n_edits', all_n_edits.has(rpost_id)?all_n_edits.get(rpost_id):-1);
		fetch('./op.php', {method: 'POST', body: pingFormData }) //.then(res => {console.log(res); return res;})
		.then(res => res.json())
		.then(res => updateForum(res))
		.catch(e => console.error('Error, pingAndFetch(), ' + e));
	}

	var titles_datetime = new Date();
	function forumTimer()
	{
		setTimeout(forumTimer, 2*1000);
		if (chkFetchTitles.checked)	
		{
			pingAndFetch();
			titles_datetime.setTime(Date.now());
			document.getElementById('datetime').innerHTML = titles_datetime.toDateString() + ' ' + titles_datetime.toLocaleTimeString();
			chkFetchTitles.checked = false;
		}
	}
 
	
	function touchTitleStarted() { tTitleTouchStarted = performance.now();}
	window.onscroll = function() { tScrolled = performance.now(); }; //var y = window.scrollY
</script>

<script id="script_init">
	setPageState(pagestates.FETCHTITLES);
	forumTimer();
</script>

</body>
</html>
 